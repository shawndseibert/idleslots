<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idle Slot Machine - Ultra Rewarded Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>

        body {
            font-family: 'Poppins', sans-serif;
            touch-action: manipulation;
            transition: background 0.5s ease-out;
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE10+/Edge */
            user-select: none; /* Standard */
        }
        #background-transition-overlay {
            position: fixed;
            inset: 0;
            z-index: -2;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.8s ease-in-out;
        }
        .slot-container {
            position: relative;
        }
        .slot {
            width: 100px;
            height: 100px;
            border: 4px solid #4B5563;
            background-color: #F9FAFB;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 6px 10px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease, background-color 0.3s ease;
            flex-shrink: 1;
        }

        @media (max-width: 400px) {
            .slot {
                width: 22vw;
                height: 22vw;
                font-size: 10vw;
            }
        }

        .slot::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 12px;
            z-index: -1;
            box-shadow: var(--glow-shadow, none);
            transition: box-shadow 0.3s ease-in-out;
        }
        .slot-inner {
            position: absolute;
            top: 0;
            transition: top 0.1s ease-in-out;
        }
        button, .stats-panel, .slot, #game-container {
            transition: all 0.2s ease-in-out;
        }
        .spin-button:active, .store-button:active, .frenzy-button:active, .prestige-button:active, .settings-button:active, .gamble-button:active {
            transform: translateY(2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .message-box {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .badge {
            font-size: 2rem;
            position: relative;
            cursor: default;
        }
        .badge .tooltip {
            visibility: hidden;
            width: 160px;
            background-color: #111827;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            margin-left: -80px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            line-height: 1.25rem;
            pointer-events: none;
        }
         .badge .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #111827 transparent transparent transparent;
        }
        .badge:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .dynamic-badge-value {
            position: absolute;
            bottom: -5px;
            right: -8px;
            background-color: #FBBF24;
            color: #1F2937;
            border-radius: 9999px;
            padding: 0 5px;
            font-size: 0.75rem;
            font-weight: bold;
            border: 2px solid #1F2937;
        }
        @keyframes text-flash { 50% { color: #ffffff; text-shadow: 0 0 10px #ffffff; } }
        .animate-flash { animation: text-flash 0.3s ease-in-out; }

        @keyframes pop-in {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-pop-in {
            animation: pop-in 0.5s ease-out forwards;
        }

        @keyframes win-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .win-pulse { animation: win-pulse 0.5s ease-in-out; }

        @keyframes jackpot-glow {
            0% { transform: scale(1) rotate(0); } 50% { transform: scale(1.15) rotate(-3deg); } 100% { transform: scale(1) rotate(0); }
        }
        .jackpot-glow { animation: jackpot-glow 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        
        @keyframes screen-shake {
            0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(0, 0) rotate(0deg); }
        }
        .screen-shake { animation: screen-shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }

        @keyframes nudge-glow {
            0%, 100% { box-shadow: inset 0 0 15px 5px #10b981; }
            50% { box-shadow: inset 0 0 25px 10px #34d399; }
        }
        .nudge-animation { animation: nudge-glow 0.8s ease-in-out; }

        @keyframes sparkle {
            0%, 100% { text-shadow: 0 0 10px #fff, 0 0 20px #ffc, 0 0 30px #ffc; }
            50% { text-shadow: 0 0 20px #fff, 0 0 30px #ffc, 0 0 40px #ffc; }
        }
        .super-symbol { animation: sparkle 1.5s infinite; }
        
        @keyframes frenzy-glow {
            0%, 100% { box-shadow: 0 0 5px 2px #f87171, 0 0 10px 4px #ef4444, 0 0 15px 6px #dc2626; }
            50% { box-shadow: 0 0 10px 4px #f87171, 0 0 15px 6px #ef4444, 0 0 20px 8px #dc2626; }
        }
        .frenzy-glow { animation: frenzy-glow 1s ease-in-out infinite alternate; }

        @keyframes gamble-win-text {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            10% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            90% { transform: translate(-50%, -150%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -250%) scale(1.5); opacity: 0; }
        }
        .gamble-win-text { animation: gamble-win-text 3s cubic-bezier(0.17, 0.84, 0.44, 1); }

        @keyframes gamble-loss-explode {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; filter: blur(0); }
            100% { transform: translate(-50%, -50%) scale(8); opacity: 0; filter: blur(10px); }
        }
        .gamble-loss-explode { animation: gamble-loss-explode 1.5s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards; }

        @keyframes float-up {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-80px); opacity: 0; }
        }
        .floating-text {
            position: fixed;
            z-index: 1002;
            pointer-events: none;
            animation: float-up 1.5s ease-out forwards;
            font-size: 1.5rem;
            font-weight: bold;
            color: #34d399;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }

        .fall-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; }
        .falling-money-container { z-index: 2; }
        @keyframes fall { 0% { top: -10%; opacity: 1; } 100% { top: 110%; opacity: 0.5; } }
        .coin {
            position: absolute; top: -10%; font-size: 2rem; animation: fall 3s linear; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); pointer-events: auto;
        }

        .confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 1001; }
        @keyframes confetti-fall {
            0% { transform: translateY(0) rotateZ(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotateZ(720deg); opacity: 0; }
        }
        .confetti { position: absolute; top: -10px; font-size: 1.5rem; animation: confetti-fall 3s linear forwards; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3)); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 998; backdrop-filter: blur(5px); }
        .menu { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(17, 24, 39, 0.95); border: 2px solid #FBBF24; border-radius: 12px; padding: 24px; z-index: 1000; width: 90%; max-width: 450px; }
        .power-up-item { background-color: #374151; border-radius: 8px; padding: 12px; }
        .scroll-container { max-height: 60vh; overflow-y: auto; padding-right: 1rem; }
        
        .theme-inferno { --main-border: #ef4444; --title-color: #f87171; }
        #game-container { border-color: var(--main-border, #FBBF24); }
        #game-container h1 { color: var(--title-color, #FBBF24); }

        @keyframes glow-pulse-anim {
            0%, 100% { box-shadow: 0 0 15px 5px var(--glow-color, transparent), inset 0 0 10px 2px var(--spark-color, transparent); opacity: 0.7; }
            50% { box-shadow: 0 0 25px 10px var(--glow-color, transparent), inset 0 0 20px 5px var(--spark-color, transparent); opacity: 1; }
        }
        @keyframes glow-wild-anim {
            0% { box-shadow: 0 0 25px 10px var(--glow-color, transparent), inset 0 0 15px 3px var(--spark-color, transparent); transform: scale(1); }
            50% { box-shadow: 0 0 40px 15px var(--glow-color, transparent), inset 0 0 25px 8px var(--spark-color, transparent); transform: scale(1.02); }
            100% { box-shadow: 0 0 25px 10px var(--glow-color, transparent), inset 0 0 15px 3px var(--spark-color, transparent); transform: scale(1); }
        }
        #game-container::before {
            content: "";
            position: absolute;
            inset: -5px;
            z-index: -1;
            border-radius: 1.25rem;
            transition: box-shadow 0.3s ease-in-out, opacity 0.3s ease-in-out;
            box-shadow: 0 0 15px 5px transparent;
            opacity: 0;
        }
        #game-container.is-glowing::before { opacity: 1; }
        #game-container.glow-pulse::before { animation: glow-pulse-anim 4s ease-in-out infinite; }
        #game-container.glow-wild::before { animation: glow-wild-anim 2s ease-in-out infinite; }

        @keyframes super-crazy-bg-anim {
            0% { background-position: 0% 50%, 0 0, 0 0; }
            50% { background-position: 0% 50%, 100% 100%, 100% 50%; }
            100% { background-position: 0% 50%, 0 0, 0 0; }
        }

        /* --- Symbol Animations --- */
        @keyframes symbol-win-cherry { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-15px) scale(1.1) rotate(20deg); } }
        @keyframes symbol-win-diamond { 0% { filter: brightness(1) drop-shadow(0 0 5px #fff); } 50% { filter: brightness(2) drop-shadow(0 0 20px #60a5fa); } 100% { filter: brightness(1) drop-shadow(0 0 5px #fff); } }
        @keyframes symbol-win-bell { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(15deg); } 75% { transform: rotate(-15deg); } }
        .symbol-win-cherry { animation: symbol-win-cherry 0.6s ease-in-out; }
        .symbol-win-diamond { animation: symbol-win-diamond 0.8s ease-in-out infinite; }
        .symbol-win-bell { animation: symbol-win-bell 0.5s cubic-bezier(0.45, 0.05, 0.55, 0.95); }

        @keyframes jackpot-overdrive-symbol {
            0% { transform: scale(1); opacity: 1; }
            40% { transform: scale(5); opacity: 0.8; }
            100% { transform: scale(0.5); opacity: 0; }
        }
        .jackpot-overdrive-symbol {
            position: absolute; font-size: 5rem; z-index: 1005; pointer-events: none;
            animation: jackpot-overdrive-symbol 1s cubic-bezier(0.5, 0, 0.9, 0.5) forwards;
            filter: drop-shadow(0 0 20px white);
        }
        @keyframes grand-jackpot-text-anim {
            0% { opacity: 0; transform: scale(0.5) rotate(-15deg); }
            30% { opacity: 1; transform: scale(1.2) rotate(5deg); }
            60% { transform: scale(1.1) rotate(-3deg); }
            100% { opacity: 1; transform: scale(1.1) rotate(0deg); }
        }

        /* --- Juice Meter --- */
        #juice-meter-container {
            background-color: #1f2937; border: 2px solid #4b5563; border-radius: 10px;
            padding: 4px; margin-top: 1rem;
        }
        #juice-meter-bar {
            height: 20px; border-radius: 6px;
            background: linear-gradient(90deg, #d946ef, #a855f7, #8b5cf6);
            width: 0%;
            transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            position: relative; overflow: hidden;
        }
        #juice-meter-bar::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(90deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 100%);
            transform: translateX(-100%); animation: juice-shine 2s infinite;
        }
        @keyframes juice-shine {
            to { transform: translateX(100%); }
        }
        @keyframes ultimate-spin-glow {
            0%, 100% { box-shadow: 0 0 15px 5px #a855f7, 0 0 5px 2px #d946ef inset; }
            50% { box-shadow: 0 0 25px 10px #a855f7, 0 0 10px 4px #d946ef inset; }
        }
        .ultimate-spin-ready {
            animation: ultimate-spin-glow 1.5s ease-in-out infinite;
            background-color: #a855f7; color: white;
        }

        /* Hold & Respin */
        #hold-respin-overlay {
            position: absolute; inset: 0; background-color: rgba(10, 5, 20, 0.9);
            z-index: 10; display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        #hold-respin-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
        }
        .hold-respin-slot {
            width: 100px; height: 100px; border-radius: 50%;
            background-color: #4b5563; border: 3px solid #1f2937;
            display: flex; justify-content: center; align-items: center;
            font-size: 2.5rem; font-weight: bold; color: #facc15;
            text-shadow: 0 0 5px black;
        }
         @media (max-width: 400px) { .hold-respin-slot { width: 22vw; height: 22vw; font-size: 8vw; } }

        @keyframes hold-respin-land {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .hold-respin-slot.filled {
            background: radial-gradient(circle, #fde047, #f59e0b);
            border-color: #fde047;
            animation: hold-respin-land 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }

    </style>
</head>
<body class="text-white flex flex-col items-center justify-center min-h-screen p-4">
    <div id="background-transition-overlay"></div>

    <div id="badge-display-container" class="w-full max-w-md mx-auto mb-4 flex flex-wrap justify-center items-center gap-2 min-h-[52px]"></div>

<div id="game-container" class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-2xl w-full max-w-md border-2 relative">
                
        <div class="flex justify-center items-center mb-2 relative">
            <h1 id="game-title" class="text-4xl font-bold text-center">Idle Slots</h1>
            <div class="absolute right-0 top-1/2 -translate-y-1/2 flex items-center space-x-1">
                <button id="settingsButton" class="text-gray-400 hover:text-yellow-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
                <button id="infoButton" class="text-gray-400 hover:text-yellow-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            </div>
        </div>
        <p id="prestige-display" class="text-center text-cyan-400 mb-2 h-5"></p>
        <p id="grand-jackpot-display" class="text-center text-yellow-300 font-bold mb-2 h-5 text-lg"></p>


        <div id="stats-panel" class="stats-panel bg-gray-900 p-4 rounded-lg text-center mb-4 flex justify-around">
            <div class="w-1/2">
                <p class="text-lg text-gray-400">Your Balance</p>
                <p id="balance" class="text-4xl font-bold text-green-400">$100</p>
            </div>
            <div class="border-l border-gray-700"></div>
            <div class="w-1/2">
                <p class="text-lg text-gray-400">Session Wins</p>
                <p id="win-counter" class="text-4xl font-bold text-yellow-400">0</p>
            </div>
        </div>

        <div class="slot-container">
            <div class="flex justify-center space-x-4 mb-4">
                <div class="slot"><div id="slot1" class="slot-inner"><span>🍒</span></div></div>
                <div class="slot"><div id="slot2" class="slot-inner"><span>🍋</span></div></div>
                <div class="slot"><div id="slot3" class="slot-inner"><span>🍊</span></div></div>
            </div>
            <div id="hold-respin-overlay">
                <h2 id="hold-respin-title" class="text-4xl font-bold text-yellow-400 mb-4">HOLD & RESPIN</h2>
                <div id="hold-respin-grid"></div>
                <p id="hold-respin-counter" class="text-2xl mt-4 font-bold text-white">Respins: 3</p>
            </div>
        </div>


        <div id="message" class="message-box text-center text-xl font-semibold h-8 mb-3"></div>
        
        <div id="juice-meter-container">
            <div id="juice-meter-bar"><span id="juice-meter-text" class="absolute inset-0 flex items-center justify-center font-bold text-sm text-white text-shadow-lg">JUICE METER</span></div>
        </div>

        <div id="action-buttons" class="flex space-x-2 mt-3 mb-3">
            <button id="prestigeButton" class="prestige-button w-1/3 bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-2 rounded-lg text-sm h-16 disabled:opacity-50 text-center">
                Prestige (100 Wins)
            </button>
            <button id="storeButton" class="store-button w-1/3 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-2 rounded-lg text-sm h-16 flex justify-center items-center">
                 Store
            </button>
            <button id="frenzyButton" class="frenzy-button w-1/3 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-2 rounded-lg text-sm h-16 flex justify-center items-center disabled:bg-gray-600 disabled:opacity-50" disabled>
                <span class="text-center">Frenzy <span id="frenzy-coin-count" class="block font-semibold text-xs">(0)</span></span>
            </button>
        </div>
        
        <button id="spinButton" class="spin-button w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-5 px-4 rounded-lg text-3xl shadow-lg focus:outline-none focus:ring-4 focus:ring-yellow-300 disabled:bg-gray-600 flex items-center justify-center">
            Spin ($5)
        </button>

        <button id="gambleButton" class="gamble-button w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-5 px-4 rounded-lg text-3xl shadow-lg disabled:bg-gray-600 disabled:opacity-50 mt-3">
            Gamble
        </button>
        
    </div>

    <div id="dev-menu-overlay" class="modal-overlay hidden"></div>
    <div id="dev-menu" class="menu hidden">
        <h3 class="text-lg font-bold text-yellow-300 mb-4 text-center">Dev Menu</h3>
        <div class="space-y-2">
            <button id="dev-add-money" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">Add $1000</button>
            <button id="dev-add-wins" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Add 10 Wins</button>
            <button id="dev-add-prestige" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded">Add Prestige Lvl</button>
            <button id="dev-add-frenzy" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">Add Frenzy Token</button>
            <button id="dev-add-juice" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Fill Juice Meter</button>
            <button id="dev-spawn-powerup" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">Spawn Power-Up</button>
            <button id="dev-unlock-milestones" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded">Unlock Milestones</button>
            <button id="dev-reset" class="w-full bg-red-800 hover:bg-red-900 text-white font-bold py-2 px-4 rounded mt-4">Full Game Reset</button>
        </div>
        <button id="dev-close" class="mt-4 w-full text-gray-400 hover:text-white">Close</button>
    </div>

    <div id="store-menu-overlay" class="modal-overlay hidden"></div>
    <div id="store-menu" class="menu hidden">
        <h3 class="text-2xl font-bold text-purple-400 mb-4 text-center">Power-Up Store</h3>
        <div id="power-ups-container" class="scroll-container space-y-4"></div>
        <button id="store-close" class="mt-6 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Close</button>
    </div>

    <div id="settings-menu-overlay" class="modal-overlay hidden"></div>
    <div id="settings-menu" class="menu hidden">
        <h3 class="text-2xl font-bold text-gray-400 mb-4 text-center">Settings</h3>
        
        <h4 class="text-lg font-bold text-gray-300 mt-6 mb-2 text-center">Volume Controls</h4>
        <div class="space-y-3">
            <div class="flex items-center space-x-3">
                <label for="master-volume" class="w-16">Master</label>
                <input id="master-volume" type="range" min="0" max="1" step="0.01" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                <span id="master-volume-label" class="w-12 text-right">100%</span>
            </div>
            <div class="flex items-center space-x-3">
                <label for="sfx-volume" class="w-16">SFX</label>
                <input id="sfx-volume" type="range" min="0" max="1" step="0.01" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                <span id="sfx-volume-label" class="w-12 text-right">75%</span>
            </div>
        </div>

        <div class="border-t border-gray-700 my-6"></div>

        <div id="settings-options">
            <button id="reset-progress-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Reset Game Progress</button>
        </div>
        <div id="reset-confirmation" class="hidden">
            <p class="text-center text-red-400 mb-2">Are you sure? This cannot be undone.</p>
            <div class="flex space-x-2">
                <button id="confirm-reset-button" class="w-1/2 bg-red-800 hover:bg-red-900 text-white font-bold py-2 px-4 rounded">Confirm</button>
                <button id="cancel-reset-button" class="w-1/2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Cancel</button>
            </div>
        </div>
        <button id="settings-close" class="mt-6 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Close</button>
    </div>

    <div id="gamble-menu-overlay" class="modal-overlay hidden"></div>
    <div id="gamble-menu" class="menu hidden">
        <h3 class="text-2xl font-bold text-yellow-400 mb-2 text-center">Gamble Your Balance!</h3>
        <p class="text-center text-lg mb-4">Choose a percentage to wager. 50/50 chance to double it or lose it all!</p>
        <div class="flex justify-between space-x-2 mt-4">
            <button class="gamble-wager-button w-1/4 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-2 rounded-lg text-sm flex items-center justify-center" data-wager="0.25">25%</button>
            <button class="gamble-wager-button w-1/4 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-2 rounded-lg text-sm flex items-center justify-center" data-wager="0.50">50%</button>
            <button class="gamble-wager-button w-1/4 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-2 rounded-lg text-sm flex items-center justify-center" data-wager="0.75">75%</button>
            <button class="gamble-wager-button w-1/4 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-2 rounded-lg text-sm flex items-center justify-center" data-wager="1.00">100%</button>
        </div>
        <button id="gamble-close" class="mt-4 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Cancel</button>
    </div>

    <div id="info-menu-overlay" class="modal-overlay hidden"></div>
    <div id="info-menu" class="menu hidden">
        <h3 class="text-2xl font-bold text-yellow-300 mb-4 text-center">Game Info</h3>
        <div id="info-content-container" class="scroll-container space-y-4 text-gray-300">
            <div>
                <h4 class="text-lg font-semibold text-purple-400 mb-2">Symbol Payouts & Upgrades</h4>
                <div id="payout-info" class="space-y-1"></div>
            </div>
             <div>
                <h4 class="text-lg font-semibold text-purple-400 mt-4 mb-2">Achievements</h4>
                <div id="badge-info" class="space-y-2"></div>
            </div>
             <div>
                <h4 class="text-lg font-semibold text-purple-400 mt-4 mb-2">Special Rules</h4>
                <ul class="list-disc list-inside space-y-2">
                    <li><span class="font-bold text-purple-400">Juice Meter:</span> Every win fills the meter. A full meter lets you unleash an <span class="font-bold">ULTIMATE SPIN</span> for a guaranteed jackpot!</li>
                    <li><span class="font-bold text-yellow-400">Hold & Respin:</span> Land 3 🪙 symbols to start a bonus round. Fill the grid to win the <span class="font-bold">GRAND JACKPOT!</span></li>
                    <li><span class="font-bold text-cyan-400">Prestige:</span> At 100 wins, you can Prestige. This resets your progress but grants a permanent <span class="font-bold">+25%</span> earnings boost per prestige level.</li>
                    <li><span class="font-bold text-red-400">Frenzy Mode:</span> Use a Frenzy Token for 15 seconds of free, fast-paced spins with a payout multiplier.</li>
                    <li><span class="font-bold text-pink-400">Intensity:</span> For every 10 wins, the game's intensity increases, making spins faster and adding visual effects.</li>
                    <li><span class="font-bold text-yellow-300">Power-Up:</span> Randomly, a falling star (⭐) will appear. Click it for a free cash bonus that scales with your session wins!</li>
                </ul>
            </div>
        </div>
        <button id="info-close" class="mt-6 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Close</button>
    </div>

    <div id="falling-money-container" class="fall-container"></div>
    <div id="falling-powerup-container" class="fall-container"></div>
    <div id="confetti-container" class="confetti-container"></div>

    <script>
        // --- Game State Variables ---
        let balance = 100;
        let spinCost = 5;
        let idleIncome = 1;
        const idleInterval = 1000;
        let prestigeLevel = 0;
        let wins = 0;
        let totalWins = 0;
        let secretTitleClicks = 0;
        let baseSymbols = [];
        let weightedSymbols = [];
        const anyTwoCherriesPayout = 10;
        const anyOneCherryPayout = 4;
        let juiceMeter = 0;
        const maxJuice = 1000;
        let grandJackpot = 100000;

        // --- DOM Element Variables ---
        let gameContainer, gameTitle, statsPanel, balanceDisplay, winCounter, prestigeDisplay, grandJackpotDisplay,
            slotElementsWithParents, slotElements, spinButton, storeButton, settingsButton,
            infoButton, prestigeButton, messageBox, devMenu, devMenuOverlay, storeMenu,
            storeMenuOverlay, settingsMenu, settingsMenuOverlay, gambleMenu, gambleMenuOverlay,
            infoMenu, infoMenuOverlay, powerUpsContainer, fallingMoneyContainer, fallingPowerUpContainer, 
            confettiContainer, frenzyButton, frenzyCoinCount, gambleButton, gambleWagerButtons, 
            badgeDisplayContainer, masterVolumeSlider, sfxVolumeSlider, masterVolumeLabel, sfxVolumeLabel,
            juiceMeterBar, juiceMeterText, ultimateSpinButton,
            holdRespinOverlay, holdRespinGrid, holdRespinCounter;

        // --- Audio Synths & Music ---
        let volumeSettings = { master: 1, sfx: 0.75 };
        let isAudioReady = false;
        const masterVolume = new Tone.Volume(0).toDestination();
        const sfxVolume = new Tone.Volume(0).connect(masterVolume);
        const membraneSynth = new Tone.MembraneSynth().connect(sfxVolume);
        const errorSynth = new Tone.FMSynth({ harmonicity: 8, modulationIndex: 2, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 } }).connect(sfxVolume);
        const winSynth = new Tone.MetalSynth({ frequency: 250, envelope: { attack: 0.001, decay: 0.2, release: 0.1 }, harmonicity: 5.1, modulationIndex: 32, resonance: 3000, octaves: 1.5 }).connect(sfxVolume);
        const jackpotSynth = new Tone.PolySynth(Tone.Synth).connect(sfxVolume);
        const levelUpSynth = new Tone.FMSynth().connect(sfxVolume);
        const purchaseSynth = new Tone.Synth({ oscillator: { type: 'triangle' } }).connect(sfxVolume);
        const prestigeSynth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.1, decay: 0.5, sustain: 0.1, release: 1 } }).connect(sfxVolume);
        const frenzySynth = new Tone.AMSynth().connect(sfxVolume);
        const badgeSynth = new Tone.MembraneSynth({ pitchDecay: 0.008, octaves: 8, envelope: { attack: 0.001, decay: 0.5, sustain: 0 } }).connect(sfxVolume);
        const juiceSynth = new Tone.FMSynth({ harmonicity: 1.5, modulationIndex: 10, envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 } }).connect(sfxVolume);
        const holdRespinSynth = new Tone.MembraneSynth({ pitchDecay: 0.05, octaves: 10, envelope: { attack: 0.001, decay: 0.3, sustain: 0 } }).connect(sfxVolume);
        let frenzyPattern;

        // --- Game Logic Variables ---
        let isSpinning = false;
        let isHoldRespinActive = false;
        let coinInterval;
        let autoSpinnerInterval;
        let isFrenzyActive = false;
        let milestones = {};
        let badges = {};
        const intensityColors = ['#4f46e5', '#db2777', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6'];
        let saveTimeout;
        let isTransitioningBackground = false;
        
        // --- Helper Functions ---
        function formatNumber(num) {
            const value = Math.floor(num);
            if (value < 10000) return value.toLocaleString();
            if (value >= 1e3 && value < 1e6) return +(value / 1e3).toFixed(1) + "k";
            if (value >= 1e6 && value < 1e9) return +(value / 1e6).toFixed(1) + "M";
            if (value >= 1e9 && value < 1e12) return +(value / 1e9).toFixed(1) + "B";
            if (value >= 1e12) return +(value / 1e12).toFixed(1) + "T";
        }

        function seededRandom(seed) {
            const x = Math.sin(seed + 1) * 10000;
            return x - Math.floor(x);
        }
        
        // --- Game Setup ---
        function initializeSymbols() {
            baseSymbols = [ 
                { key: 'coin', emoji: '🪙', payout3: 0, payout2: 0, level: 0, basePayout3: 0, basePayout2: 0, upgradeCost: 0, isSpecial: true },
                { key: 'diamond', emoji: '💎', payout3: 500, payout2: 50, level: 0, basePayout3: 500, basePayout2: 50, upgradeCost: 50000 }, 
                { key: 'clover', emoji: '🍀', payout3: 200, payout2: 30, level: 0, basePayout3: 200, basePayout2: 30, upgradeCost: 20000 }, 
                { key: 'bell', emoji: '🔔', payout3: 100,  payout2: 20, level: 0, basePayout3: 100, basePayout2: 20, upgradeCost: 10000 }, 
                { key: 'grape', emoji: '🍇', payout3: 40,  payout2: 10, level: 0, basePayout3: 40, basePayout2: 10, upgradeCost: 4000 }, 
                { key: 'orange', emoji: '🍊', payout3: 30,  payout2: 6, level: 0, basePayout3: 30, basePayout2: 6, upgradeCost: 3000 }, 
                { key: 'lemon', emoji: '🍋', payout3: 20,  payout2: 4, level: 0, basePayout3: 20, basePayout2: 4, upgradeCost: 2000 }, 
                { key: 'cherry', emoji: '🍒', payout3: 15, payout2: 2, level: 0, basePayout3: 15, basePayout2: 2, upgradeCost: 1500 }
            ];
            updateWeightedSymbols();
        }

        function updateWeightedSymbols() {
            weightedSymbols = [];
            baseSymbols.forEach(s => {
                if (s.isSpecial) return; // Don't add special symbols like the Coin to the general pool
                // Base weight of 10, less for valuable symbols
                const weight = Math.max(1, 10 - Math.log2(s.basePayout3 || 1));
                for(let i = 0; i < weight; i++) {
                    weightedSymbols.push(s);
                }
            });
            // Manually add a few coins to the weighted list to control their rarity
            const coinSymbol = baseSymbols.find(s => s.key === 'coin');
            if (coinSymbol) { weightedSymbols.push(coinSymbol); weightedSymbols.push(coinSymbol); }
        }

        function initializeBadges() {
             badges = { winCounter: { name: 'Total Wins', unlocked: true, dynamic: true, icon: '🏆', description: 'Your total wins across all prestiges.', order: 1 }, grandJackpot: { name: 'High Roller', unlocked: false, icon: '🤑', description: 'Win the Grand Jackpot in a Hold & Respin round.', order: 16 }, win10: { name: 'Getting Started', unlocked: false, icon: '🥉', description: 'Reach 10 total wins.', order: 2 }, win100: { name: 'Slot Pro', unlocked: false, icon: '🥈', description: 'Reach 100 total wins.', order: 3 }, win500: { name: 'Slot Hotshot', unlocked: false, icon: '🥇', description: 'Reach 500 total wins.', order: 4 }, win1000: { name: 'Slot Master', unlocked: false, icon: '🏅', description: 'Reach 1,000 total wins.', order: 5 }, bal1M: { name: 'Millionaire', unlocked: false, icon: '💰', description: 'Reach a balance of $1,000,000.', order: 8 }, bal1B: { name: 'Billionaire', unlocked: false, icon: '💎', description: 'Reach a balance of $1,000,000,000.', order: 9 }, prestige1: { name: 'New Beginning', unlocked: false, icon: '🌀', description: 'Prestige for the first time.', order: 10 }, prestige5: { name: 'Loop Master', unlocked: false, icon: '🌌', description: 'Reach Prestige Level 5.', order: 11 }, frenzy10: { name: 'Fever Pitch', unlocked: false, icon: '🔥', description: 'Activate Frenzy Mode 10 times.', order: 12, value: 0 }, allIn: { name: 'All In!', unlocked: false, icon: '🎲', description: 'Win a 100% wager gamble.', order: 13 }, collector: { name: 'Collector', unlocked: false, icon: '🛍️', description: 'Buy one of every Power-Up.', order: 14 }, chain: { name: 'Chain Reaction', unlocked: false, icon: '⛓️', description: 'Achieve a Jackpot Chain.', order: 15 }, secretNudge: { name: 'Just a Nudge', unlocked: false, icon: '❓', description: 'Sometimes you get a little help.', order: 100, secret: true }, secretClicker: { name: 'Bored?', unlocked: false, icon: '❓', description: 'You clicked the title 10 times.', order: 101, secret: true }, };
        }

        function resetProgress() {
            initializeBadges();
            initializeSymbols();
            powerUps = { autoSpinner: { name: 'Auto Spinner', description: 'Spins faster with each level.', cost: 200, level: 0 }, incomeBoost: { name: 'Income Boost', description: 'Increases idle income by $1/s.', cost: 250, level: 0 }, winMultiplier: { name: 'Win Multiplier', description: 'Increases all wins by 10%.', cost: 1000, level: 0 }, nudge: { name: 'Lucky Nudge', description: 'Chance to turn a near-miss into a jackpot.', cost: 750, level: 0 }, symbolMagnet: { name: 'Diamond Magnet', description: 'Increases chance of landing 💎.', cost: 1500, level: 0 }, jackpotChain: { name: 'Jackpot Chain', description: 'Jackpots can re-spin with a 2x multiplier.', cost: 5000, level: 0 }, frenzyToken: { name: 'Frenzy Token', description: '15s of free, fast, 2x-payout spins.', cost: 2000, count: 0 }, bonusBonanza: { name: 'Bonus Bonanza', description: 'Boosts effectiveness of other powerups.', cost: 10000, level: 0 }, frenzyFuel: { name: 'Frenzy Fuel', description: 'Improves Frenzy Mode duration & multiplier.', cost: 8000, level: 0 }, };
            milestones = { 250: { unlocked: false, description: 'Unlock the 👑 symbol!' }, 500: { unlocked: false, description: 'Win Multiplier is now 5% more effective!' }, 1000: { unlocked: false, description: 'Unlock the Inferno theme!' } };
            juiceMeter = 0;
            grandJackpot = 100000;
        }
        
        // --- Save & Load ---
        function saveGameState() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                const gameState = { balance, wins, totalWins, idleIncome, prestigeLevel, powerUps, milestones, badges, secretTitleClicks, volumeSettings, juiceMeter, grandJackpot, symbolLevels: baseSymbols.map(s => ({ key: s.key, level: s.level })) };
                localStorage.setItem('idleSlotMachineSave', JSON.stringify(gameState));
            }, 500);
        }

        function loadGameState() {
            resetProgress();
            
            const savedData = localStorage.getItem('idleSlotMachineSave');
            if (savedData) {
                try {
                    const gameState = JSON.parse(savedData);
                    balance = gameState.balance ?? 100;
                    wins = gameState.wins ?? 0;
                    totalWins = gameState.totalWins ?? gameState.wins ?? 0;
                    idleIncome = gameState.idleIncome ?? 1;
                    prestigeLevel = gameState.prestigeLevel ?? 0;
                    secretTitleClicks = gameState.secretTitleClicks ?? 0;
                    juiceMeter = gameState.juiceMeter ?? 0;
                    grandJackpot = gameState.grandJackpot ?? 100000;

                    if (gameState.volumeSettings) volumeSettings = { ...volumeSettings, ...gameState.volumeSettings };
                    if (gameState.badges) { Object.keys(gameState.badges).forEach(key => { if (badges[key]) { badges[key] = { ...badges[key], ...gameState.badges[key] }; } }); }
                    if (gameState.powerUps) { Object.keys(gameState.powerUps).forEach(key => { if (powerUps[key]) { powerUps[key] = { ...powerUps[key], ...gameState.powerUps[key] }; } }); }
                    if (gameState.milestones) { Object.keys(gameState.milestones).forEach(key => { if (milestones[key]) { milestones[key] = { ...milestones[key], ...gameState.milestones[key] }; } }); }
                    if (gameState.symbolLevels) {
                        gameState.symbolLevels.forEach(savedSymbol => {
                            const symbol = baseSymbols.find(s => s.key === savedSymbol.key);
                            if (symbol) {
                                for (let i = 0; i < savedSymbol.level; i++) {
                                    applySymbolUpgrade(symbol, false); // apply without cost
                                }
                            }
                        });
                    }

                    if (milestones[250]?.unlocked && !baseSymbols.some(s => s.emoji === '👑')) { baseSymbols.unshift({ key: 'king', emoji: '👑', payout3: 1000, payout2: 100, level: 0, basePayout3: 1000, basePayout2: 100, upgradeCost: 100000 }); }
                    
                    if (powerUps.autoSpinner.level > 0) {
                        const autoSpinSpeed = Math.max(400, 3000 - (powerUps.autoSpinner.level - 1) * 400);
                        autoSpinnerInterval = setInterval(spin, autoSpinSpeed);
                        spinButton.textContent = 'Auto';
                    }
                    if (powerUps.symbolMagnet.level > 0) {
                        updateWeightedSymbols(); // re-init
                        const diamond = baseSymbols.find(s => s.emoji === '💎');
                        if (diamond) { for (let i = 0; i < powerUps.symbolMagnet.level * 2; i++) weightedSymbols.push(diamond); }
                    }
                    if (milestones[1000]?.unlocked) { gameContainer.classList.add('theme-inferno'); }
                } catch (error) {
                    console.error("Failed to load saved data. Starting a new game.", error);
                    fullReset(false);
                }
            }
            
            updateBackground(true);
            applyVolumeSettings();
            updateBalanceDisplay();
            updateWinCounter();
            updatePrestigeButton();
            updateIntensity();
            updateJuiceMeter();
            renderInfo();
            renderBadges();
        }

        // --- Core UI & Game Logic ---
        async function initializeAudio() {
            if (isAudioReady) return;
            await Tone.start();
            isAudioReady = true;
        }

        function updateBalanceDisplay() {
            balanceDisplay.textContent = `$${formatNumber(balance)}`;
            balanceDisplay.classList.add('animate-flash');
            setTimeout(() => balanceDisplay.classList.remove('animate-flash'), 300);
            if (!isSpinning) { spinButton.disabled = balance < spinCost || isHoldRespinActive; }
            gambleButton.disabled = balance <= 0 || isHoldRespinActive;
            checkBadgeUnlocks();
        }
        function updateWinCounter() { 
            winCounter.textContent = wins;
            winCounter.classList.add('animate-flash');
            setTimeout(() => winCounter.classList.remove('animate-flash'), 300);
            prestigeButton.disabled = wins < 100;
            checkMilestones();
            checkBadgeUnlocks();
        }

        function updatePrestigeButton() {
            if (prestigeLevel > 0) {
                prestigeButton.innerHTML = `Prestige <span class="block text-xs opacity-80">Lvl ${prestigeLevel} (+${prestigeLevel * 25}%)</span>`;
            } else {
                prestigeButton.textContent = 'Prestige (100 Wins)';
            }
        }

        function updateJuiceMeter() {
            const percentage = Math.min(100, (juiceMeter / maxJuice) * 100);
            juiceMeterBar.style.width = `${percentage}%`;

            if (percentage >= 100) {
                spinButton.classList.add('ultimate-spin-ready');
                spinButton.textContent = "ULTIMATE SPIN";
                juiceMeterText.textContent = "READY!";
            } else {
                spinButton.classList.remove('ultimate-spin-ready');
                 if (powerUps.autoSpinner.level > 0) {
                    spinButton.textContent = 'Auto';
                } else {
                    spinButton.textContent = `Spin ($${spinCost})`;
                }
                juiceMeterText.textContent = "JUICE METER";
            }
        }

        function addJuice(amount) {
            if (juiceMeter >= maxJuice) return;
            juiceMeter = Math.min(maxJuice, juiceMeter + amount);
            if(isAudioReady && juiceMeter < maxJuice) {
                juiceSynth.frequency.value = 200 + (juiceMeter/maxJuice) * 400;
                juiceSynth.triggerAttackRelease("16n");
            } else if (isAudioReady && juiceMeter >= maxJuice) {
                levelUpSynth.triggerAttackRelease("C5", "4n");
            }
            updateJuiceMeter();
        }


        function updateBackground(isInstant = false) {
            if (isTransitioningBackground && !isInstant) return;

            const calculateGradient = () => {
                const intensityLevel = Math.floor(wins / 10);

                if (wins >= 1000) {
                    return `radial-gradient(ellipse at 70% 80%, hsla(300, 100%, 50%, 0.5), transparent), radial-gradient(ellipse at 30% 20%, hsla(180, 100%, 50%, 0.5), transparent), linear-gradient(135deg, #ff0000, #ffff00, #00ff00, #0000ff, #ff00ff)`;
                }
                if (intensityLevel < 2) {
                    const calmAngle = 160, darkGray = 'hsl(0, 0%, 10%)', lightGray = 'hsl(0, 0%, 15%)';
                    if (intensityLevel === 1) { 
                        return `linear-gradient(${calmAngle}deg, ${darkGray}, ${intensityColors[0]}, ${lightGray})`;
                    } else {
                        return `linear-gradient(${calmAngle}deg, ${darkGray}, ${lightGray})`;
                    }
                }
                const progress = (wins - 20) / 980;
                const baseHue = Math.floor(seededRandom(prestigeLevel) * 360);
                const angle = Math.floor(180 + progress * 180);
                const numColors = 2 + Math.floor(progress * 5);
                const saturation = 50 + progress * 50;
                const lightness = 40 - progress * 25;
                const colors = [];
                for (let i = 0; i < numColors; i++) {
                    const hue = (baseHue + (i * (360 / numColors)) + (wins * 0.5)) % 360;
                    colors.push(`hsl(${hue}, ${saturation}%, ${lightness}%)`);
                }
                const colorIndex = (intensityLevel - 1) % intensityColors.length;
                colors.push(intensityColors[colorIndex]);
                return `linear-gradient(${angle}deg, ${colors.join(', ')})`;
            };
            
            const newGradient = calculateGradient();
            const body = document.body;

            if (isInstant || body.style.background === '') {
                body.style.background = newGradient;
                if(wins >= 1000) body.style.animation = 'super-crazy-bg-anim 4s linear infinite';
                return;
            }

            if (newGradient === body.style.background) return;

            isTransitioningBackground = true;
            const overlay = document.getElementById('background-transition-overlay');
            overlay.style.background = newGradient;
            overlay.style.opacity = 1;

            setTimeout(() => {
                body.style.background = newGradient;
                if (wins >= 1000) {
                     body.style.animation = 'super-crazy-bg-anim 4s linear infinite';
                } else {
                    body.style.animation = '';
                }
                overlay.style.opacity = 0;
                setTimeout(() => { isTransitioningBackground = false; }, 200);
            }, 800);
        }
        
        function showMessage(text, colorClass = 'text-yellow-300', duration = 2000, isBadge = false) {
            if (isBadge && isAudioReady) badgeSynth.triggerAttackRelease("C4", "8n");
            const intensityLevel = Math.floor(wins / 10);
            const effectiveDuration = Math.max(800, duration - intensityLevel * 150);
            messageBox.textContent = text;
            messageBox.className = `message-box text-center text-xl font-semibold h-8 mb-3 opacity-100 transform translate-y-0 ${colorClass}`;
            setTimeout(() => { messageBox.style.opacity = '0'; messageBox.style.transform = 'translateY(-10px)'; }, effectiveDuration);
        }

        function showFloatingText(text, x, y) {
            const floatingText = document.createElement('div');
            floatingText.textContent = text;
            floatingText.className = 'floating-text';
            floatingText.style.left = `${x}px`;
            floatingText.style.top = `${y}px`;
            document.body.appendChild(floatingText);
            floatingText.addEventListener('animationend', () => floatingText.remove());
        }

        function spin(options = {}) {
            if (juiceMeter >= maxJuice) {
                triggerUltimateSpin();
                return;
            }

            const { isFree = false, isChain = false, chainMultiplier = 1 } = options;
            if (isSpinning || isHoldRespinActive ||(balance < spinCost && !isFree)) {
                if(balance < spinCost && !isSpinning && !isFree) { if(isAudioReady) errorSynth.triggerAttackRelease("C2", "8n"); showMessage("Not enough money!", 'text-red-400'); }
                return;
            }
            if(isAudioReady) membraneSynth.triggerAttackRelease("C4", "8n", Tone.now());
            isSpinning = true; 
            if (!isFree) { balance -= spinCost; }
            spinButton.disabled = true; updateBalanceDisplay();
            const intensityLevel = Math.floor(wins / 10);
            let spinDuration = Math.max(400, 2000 - intensityLevel * 200);
            if (isFrenzyActive) spinDuration = 250;
            
            let spinIntervals = [];
            slotElements.forEach((reel, index) => { 
                reel.parentElement.classList.remove('win-pulse', 'jackpot-glow');
                spinIntervals[index] = setInterval(() => { 
                    const symbol = getRandomSymbol();
                    reel.innerHTML = `<span class="${symbol.isSuper ? 'super-symbol' : ''}">${symbol.emoji}</span>`;
                }, 50); 
            });
            const finalSymbols = [getRandomSymbol(), getRandomSymbol(), getRandomSymbol()];
            setTimeout(() => stopReel(0, finalSymbols[0], spinIntervals[0]), spinDuration * 0.5);
            setTimeout(() => stopReel(1, finalSymbols[1], spinIntervals[1]), spinDuration * 0.75);
            setTimeout(() => stopReel(2, finalSymbols[2], spinIntervals[2], () => { isSpinning = false; checkWin(finalSymbols, {isChain, chainMultiplier}); updateBalanceDisplay(); }), spinDuration);
        }

        function triggerUltimateSpin() {
            if (juiceMeter < maxJuice) return;
            juiceMeter = 0;
            updateJuiceMeter();
            if(isAudioReady) prestigeSynth.triggerAttackRelease("G4", "1s");

            isSpinning = true;
            spinButton.disabled = true;

            let spinIntervals = [];
            slotElements.forEach((reel, index) => {
                spinIntervals[index] = setInterval(() => {
                    reel.innerHTML = `<span>${getRandomSymbol().emoji}</span>`;
                }, 50);
            });
            
            const jackpotSymbol = weightedSymbols.reduce((a, b) => a.payout3 > b.payout3 ? a : b);
            const finalSymbols = [jackpotSymbol, jackpotSymbol, jackpotSymbol];

            setTimeout(() => {
                clearInterval(spinIntervals[0]);
                slotElements[0].innerHTML = `<span>${finalSymbols[0].emoji}</span>`;
            }, 1500);
            setTimeout(() => {
                clearInterval(spinIntervals[1]);
                slotElements[1].innerHTML = `<span>${finalSymbols[1].emoji}</span>`;
            }, 2000);
            setTimeout(() => {
                clearInterval(spinIntervals[2]);
                slotElements[2].innerHTML = `<span>${finalSymbols[2].emoji}</span>`;
                isSpinning = false;
                checkWin(finalSymbols, { isUltimate: true });
                updateBalanceDisplay();
            }, 2500);
        }

        function stopReel(reelIndex, finalSymbol, intervalId, callback) {
            clearInterval(intervalId);
            if(isAudioReady) membraneSynth.triggerAttackRelease("C3", "8n", Tone.now());
            const symbolData = baseSymbols.find(s => s.key === finalSymbol.key);
            let symbolGlowClass = symbolData && symbolData.level > 1 ? 'super-symbol' : '';
            slotElements[reelIndex].innerHTML = `<span class="${finalSymbol.isSuper || symbolGlowClass ? 'super-symbol' : ''}">${finalSymbol.emoji}</span>`;
            if (callback) callback();
        }

        function getRandomSymbol() { 
            const symbol = { ...weightedSymbols[Math.floor(Math.random() * weightedSymbols.length)] };
            if (prestigeLevel > 0 && Math.random() < 0.02) {
                symbol.isSuper = true;
            }
            return symbol;
        }

        function updateIntensity() {
            const intensityLevel = Math.floor(wins / 10);
            
            gameContainer.classList.remove('is-glowing', 'glow-pulse', 'glow-wild');
            gameContainer.style.animationDuration = '';
            gameContainer.style.setProperty('--spark-color', 'transparent');

            if (intensityLevel > 0) {
                const colorIndex = (intensityLevel - 1) % intensityColors.length;
                const color = intensityColors[colorIndex];
                
                gameContainer.style.setProperty('--glow-color', color);
                gameContainer.classList.add('is-glowing');

                if (intensityLevel > 3) {
                     gameContainer.style.setProperty('--spark-color', '#fbbf24');
                }

                if (intensityLevel <= 10) {
                    gameContainer.classList.add('glow-pulse');
                } else {
                    gameContainer.classList.add('glow-wild');
                    const duration = Math.max(0.8, 2 - (intensityLevel - 10) * 0.1);
                    gameContainer.style.animationDuration = `${duration}s`;
                }
                
                const slotGlowStyle = `0 0 15px 5px ${color}`;
                slotElementsWithParents.forEach(slot => {
                    slot.style.setProperty('--glow-shadow', slotGlowStyle);
                });

            } else {
                slotElementsWithParents.forEach(slot => {
                    slot.style.removeProperty('--glow-shadow');
                });
            }

            clearInterval(coinInterval);
            if (intensityLevel > 0) {
                const intervalTime = Math.max(20, 500 - intensityLevel * 40);
                coinInterval = setInterval(createFallingCoin, intervalTime);
            }
        }

        function createFallingCoin(xPos = null, yPos = null) {
            const intensityLevel = Math.floor(wins / 10);
            const maxCoins = Math.min(30, Math.floor(intensityLevel * 1.5));
            if (fallingMoneyContainer.childElementCount > maxCoins) {
                return;
            }
            const coin = document.createElement('div');
            coin.classList.add('coin'); coin.textContent = '💰';
            coin.style.left = xPos !== null ? `${xPos}px` : `${Math.random() * 100}vw`;
            coin.style.top = yPos !== null ? `${yPos}px` : '-10%';
            coin.style.animationDuration = `${2 + Math.random() * 2}s`;
            coin.style.fontSize = `${1.5 + Math.random()}rem`;
            fallingMoneyContainer.appendChild(coin);
            setTimeout(() => { coin.remove(); }, 4000);
        }
        
        function triggerWinAnimation(winningReelsIndices, winType) {
            winningReelsIndices.forEach(index => {
                const slotParent = slotElementsWithParents[index];
                const symbolEl = slotElements[index].querySelector('span');
                const symbolData = baseSymbols.find(s => s.emoji === symbolEl.textContent);

                if (winType === 'jackpot') {
                    slotParent.classList.add('jackpot-glow');
                } else {
                    slotParent.classList.add('win-pulse');
                }

                if (symbolData) {
                    let animationClass = '';
                    switch (symbolData.key) {
                        case 'cherry': animationClass = 'symbol-win-cherry'; break;
                        case 'diamond': animationClass = 'symbol-win-diamond'; break;
                        case 'bell': animationClass = 'symbol-win-bell'; break;
                    }
                    if (animationClass && symbolEl) {
                        symbolEl.classList.add(animationClass);
                        setTimeout(() => symbolEl.classList.remove(animationClass), 800);
                    }
                }
            });
        }
        
        function triggerJackpotOverdrive(symbol) {
            gameContainer.classList.add('screen-shake');
            setTimeout(() => gameContainer.classList.remove('screen-shake'), 500);

            slotElements.forEach(slot => {
                const el = document.createElement('div');
                el.className = 'jackpot-overdrive-symbol';
                el.textContent = symbol.emoji;
                const rect = slot.getBoundingClientRect();
                const containerRect = gameContainer.getBoundingClientRect();
                el.style.left = `${rect.left - containerRect.left + rect.width / 2}px`;
                el.style.top = `${rect.top - containerRect.top + rect.height / 2}px`;
                gameContainer.appendChild(el);
                el.addEventListener('animationend', () => el.remove());
            });

            createConfetti();
        }

        function checkWin(resultSymbols, spinOptions = {}) {
            let { isChain = false, chainMultiplier = 1, isUltimate = false } = spinOptions;

            // Check for Hold & Respin trigger first
            if (resultSymbols.filter(s => s.key === 'coin').length >= 3) {
                startHoldAndRespin(resultSymbols);
                return;
            }

            let winnings = 0, winType = 'none', winningIndices = [];
            let hadNudge = false;
            
            const bonusBonanzaLvl = powerUps.bonusBonanza.level;
            const nudgeChanceBonus = bonusBonanzaLvl * 0.02;

            if (powerUps.nudge.level > 0 && !isFrenzyActive) {
                const [s1, s2, s3] = resultSymbols;
                const nudgeChance = powerUps.nudge.level * 0.05 + nudgeChanceBonus;
                 if ((s1.emoji === s2.emoji && s1.emoji !== s3.emoji && Math.random() < nudgeChance) || (s2.emoji === s3.emoji && s2.emoji !== s1.emoji && Math.random() < nudgeChance)) {
                     hadNudge = true;
                }
                if (s1.emoji === s2.emoji && s1.emoji !== s3.emoji && hadNudge) {
                    resultSymbols[2] = s1;
                    stopReel(2, s1, null);
                    slotElementsWithParents[2].classList.add('nudge-animation');
                    setTimeout(() => slotElementsWithParents[2].classList.remove('nudge-animation'), 800);
                    if (unlockBadge('secretNudge')) showMessage('Nudge!', 'text-emerald-400');
                } else if (s2.emoji === s3.emoji && s2.emoji !== s1.emoji && hadNudge) {
                    resultSymbols[0] = s2;
                    stopReel(0, s2, null);
                    slotElementsWithParents[0].classList.add('nudge-animation');
                    setTimeout(() => slotElementsWithParents[0].classList.remove('nudge-animation'), 800);
                    if (unlockBadge('secretNudge')) showMessage('Nudge!', 'text-emerald-400');
                }
            }
            
            const [s1, s2, s3] = resultSymbols;
            if (s1.emoji === s2.emoji && s2.emoji === s3.emoji && !s1.isSpecial) { winnings = s1.payout3; winType = 'jackpot'; winningIndices = [0, 1, 2]; }
            else if (s1.emoji === s2.emoji && !s1.isSpecial) { winnings = s1.payout2; winType = 'regular'; winningIndices = [0, 1]; }
            else if (s2.emoji === s3.emoji && !s2.isSpecial) { winnings = s2.payout2; winType = 'regular'; winningIndices = [1, 2]; }
            else {
                const cherryCount = resultSymbols.reduce((count, s, i) => { if (s.emoji === '🍒') count.indices.push(i); return count; }, { indices: [] });
                if (cherryCount.indices.length === 2) { winnings = anyTwoCherriesPayout; winType = 'small'; winningIndices = cherryCount.indices; }
                else if (cherryCount.indices.length === 1) { winnings = anyOneCherryPayout; winType = 'small'; winningIndices = cherryCount.indices; }
            }

            if (winnings > 0) {
                const milestoneBonus = milestones[500]?.unlocked ? 0.05 : 0;
                const winMultiplierBonus = bonusBonanzaLvl * 0.05;
                const frenzyMultiplierBonus = powerUps.frenzyFuel.level * 0.5;

                let finalMultiplier = (1 + (powerUps.winMultiplier.level * (0.1 + milestoneBonus + winMultiplierBonus))) * (1 + (prestigeLevel * 0.25));
                if (isFrenzyActive) finalMultiplier *= (2 + frenzyMultiplierBonus);
                if (isChain) { finalMultiplier *= chainMultiplier; unlockBadge('chain'); }
                if (resultSymbols.some(s => s.isSuper)) finalMultiplier *= 10;
                winnings *= finalMultiplier;

                const oldIntensity = Math.floor(wins / 10);
                wins++;
                totalWins++; 
                updateWinCounter();
                updateBackground();
                addJuice(winnings);
                grandJackpot += winnings * 0.01; // 1% of all wins go to grand jackpot
                updateGrandJackpotDisplay();


                const newIntensity = Math.floor(wins / 10);
                if (newIntensity > oldIntensity) { 
                    if(isAudioReady) levelUpSynth.triggerAttackRelease("C5", "4n");
                    showMessage(`Intensity Up!`, 'text-pink-400', 2500);
                    updateIntensity(); 
                }
                
                triggerWinAnimation(winningIndices, winType);

                if (winType === 'jackpot') {
                    let jackpotMessage = isChain ? `Chain x${chainMultiplier}! +$${formatNumber(winnings)}` : `Jackpot! +$${formatNumber(winnings)}`;
                    if(isUltimate) jackpotMessage = `ULTIMATE! +$${formatNumber(winnings)}`;
                    showMessage(jackpotMessage, 'text-green-400', 3000);
                    if(isAudioReady) { const now = Tone.now(); jackpotSynth.triggerAttackRelease(["C4", "E4", "G4"], "8n", now); }
                    triggerJackpotOverdrive(resultSymbols[0]);
                    
                    const chainChanceBonus = bonusBonanzaLvl * 0.02;
                    if (powerUps.jackpotChain.level > 0 && Math.random() < (powerUps.jackpotChain.level * 0.05 + chainChanceBonus)) {
                        setTimeout(() => spin({ isFree: true, isChain: true, chainMultiplier: chainMultiplier * 2 }), 1500);
                    }
                } else {
                    showMessage(`+ $${formatNumber(winnings)}`, 'text-blue-400');
                    if(isAudioReady) {
                        winSynth.harmonicity = 5.1 + newIntensity * 1.5; winSynth.frequency.value = 250 + newIntensity * 25;
                        winSynth.triggerAttackRelease("C5", "8n", Tone.now());
                    }
                }
                balance += winnings;
                saveGameState();
            }
        }
        
        function startIdleIncome() { setInterval(() => { if (!isSpinning && !isHoldRespinActive) { balance += (idleIncome * (1 + prestigeLevel * 0.25)); updateBalanceDisplay(); } }, idleInterval); }

        function renderStore() {
            powerUpsContainer.innerHTML = '';
            for (const key in powerUps) {
                const pu = powerUps[key];
                const item = document.createElement('div');
                item.className = 'power-up-item flex justify-between items-center';
                let levelText = pu.level > 0 ? ` (Lvl ${pu.level})` : (pu.count > 0 ? ` (x${pu.count})` : '');
                let costText = `$${formatNumber(pu.cost)}`;
                item.innerHTML = `<div><h4 class="text-lg font-bold text-purple-300">${pu.name}${levelText}</h4><p class="text-sm text-gray-400">${pu.description}</p></div><button data-key="${key}" class="buy-button bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded disabled:bg-gray-500 disabled:cursor-not-allowed">${costText}</button>`;
                powerUpsContainer.appendChild(item);
            }
            document.querySelectorAll('.buy-button').forEach(button => {
                const key = button.dataset.key;
                if (balance < powerUps[key].cost) button.disabled = true;
                button.addEventListener('click', () => buyPowerUp(key));
            });
        }
        
        function renderInfo() {
            const payoutContainer = document.getElementById('payout-info');
            payoutContainer.innerHTML = '';
            let tableHTML = `<table class="w-full text-left border-collapse"><thead><tr class="border-b border-gray-700"><th class="py-2 text-lg text-center">Symbol</th><th class="py-2 text-lg text-center">3x</th><th class="py-2 text-lg text-center">2x</th><th class="py-2 text-lg text-center">Upgrade</th></tr></thead><tbody>`;
            [...baseSymbols].filter(s => !s.isSpecial).sort((a,b) => b.basePayout3 - a.basePayout3).forEach(symbol => {
                 const upgradeButton = `<button data-key="${symbol.key}" class="upgrade-symbol-button bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-1 px-2 rounded-lg text-xs disabled:bg-gray-500" ${balance < symbol.upgradeCost ? 'disabled' : ''}>Lvl ${symbol.level} <br>($${formatNumber(symbol.upgradeCost)})</button>`;
                 tableHTML += `<tr class="border-b border-gray-800"><td class="py-2 text-2xl text-center">${symbol.emoji}</td><td class="py-2 text-lg text-center font-bold text-green-400">$${formatNumber(symbol.payout3)}</td><td class="py-2 text-lg text-center font-bold text-green-500">$${formatNumber(symbol.payout2)}</td><td class="py-2 text-center">${upgradeButton}</td></tr>`;
            });
            tableHTML += `</tbody></table>`;
            tableHTML += `<div class="mt-4 pt-2 border-t border-gray-700 space-y-2"><div class="flex items-center justify-between text-md"><span class="text-gray-400">Any Two 🍒</span><span class="font-bold text-green-500">$${formatNumber(anyTwoCherriesPayout)}</span></div><div class="flex items-center justify-between text-md"><span class="text-gray-400">Any One 🍒</span><span class="font-bold text-green-500">$${formatNumber(anyOneCherryPayout)}</span></div></div>`;
            payoutContainer.innerHTML = tableHTML;
            payoutContainer.querySelectorAll('.upgrade-symbol-button').forEach(btn => {
                btn.addEventListener('click', (e) => upgradeSymbol(e.target.dataset.key));
            });

            const badgeInfoContainer = document.getElementById('badge-info');
            badgeInfoContainer.innerHTML = '';
            Object.values(badges).filter(b => !b.secret).sort((a, b) => a.order - b.order).forEach(badge => {
                    badgeInfoContainer.innerHTML += `<div class="flex items-center"><span class="text-2xl mr-3">${badge.icon}</span><div><p class="font-semibold text-white">${badge.name}</p><p class="text-sm text-gray-400">${badge.description}</p></div></div>`;
            });
             badgeInfoContainer.innerHTML += `<div class="flex items-center"><span class="text-2xl mr-3">❓</span><p class="font-semibold text-white">???</p></div><div class="flex items-center"><span class="text-2xl mr-3">❓</span><p class="font-semibold text-white">???</p></div>`;
        }

        function upgradeSymbol(key) {
            const symbol = baseSymbols.find(s => s.key === key);
            if (!symbol || balance < symbol.upgradeCost) return;
            
            balance -= symbol.upgradeCost;
            if(isAudioReady) purchaseSynth.triggerAttackRelease("A5", "8n");
            
            applySymbolUpgrade(symbol, true);

            updateBalanceDisplay();
            renderInfo(); // Re-render to show new costs and levels
            saveGameState();
        }

        function applySymbolUpgrade(symbol, isNewPurchase) {
            if (isNewPurchase) symbol.level++;
            symbol.payout3 = Math.floor(symbol.payout3 * 1.5);
            symbol.payout2 = Math.floor(symbol.payout2 * 1.5);
            symbol.upgradeCost = Math.floor(symbol.upgradeCost * 2);

            if (symbol.level >= 2) {
                // E.g., make it a 'super symbol' permanently in terms of visuals
                updateWeightedSymbols();
            }
        }

        function buyPowerUp(key) {
            const pu = powerUps[key];
            if (balance >= pu.cost) {
                balance -= pu.cost;
                if(isAudioReady) purchaseSynth.triggerAttackRelease("C5", "8n");
                if (pu.hasOwnProperty('level')) {
                    pu.level++;
                    pu.cost = Math.floor(pu.cost * 1.6);
                    if (key === 'incomeBoost') idleIncome++;
                    else if (key === 'autoSpinner') {
                        clearInterval(autoSpinnerInterval);
                        const autoSpinSpeed = Math.max(400, 3000 - (pu.level -1) * 400);
                        autoSpinnerInterval = setInterval(spin, autoSpinSpeed);
                        spinButton.textContent = 'Auto';
                    } else if (key === 'symbolMagnet') {
                        updateWeightedSymbols();
                        const diamond = baseSymbols.find(s => s.emoji === '💎');
                        if (diamond) { for (let i = 0; i < pu.level * 2; i++) weightedSymbols.push(diamond); }
                    }
                } else {
                    pu.count++;
                    updateFrenzyButton();
                }
                updateBalanceDisplay();
                renderStore();
                saveGameState();
            }
        }

        function updateFrenzyButton() {
            frenzyButton.disabled = powerUps.frenzyToken.count <= 0;
            
            const frenzyCountSpan = document.getElementById('frenzy-coin-count');
            if(frenzyCountSpan) frenzyCountSpan.textContent = `(${powerUps.frenzyToken.count})`;

            if (!isFrenzyActive) {
                frenzyButton.classList.remove('frenzy-glow', 'screen-shake');
            }
        }

        function startFrenzy() {
            if (isFrenzyActive || powerUps.frenzyToken.count <= 0) return;
            isFrenzyActive = true;
            if (badges.frenzy10 && !badges.frenzy10.unlocked) {
                badges.frenzy10.value = (badges.frenzy10.value || 0) + 1;
            }
            powerUps.frenzyToken.count--;
            if(isAudioReady) {
                frenzyPattern = new Tone.Pattern((time, note) => { frenzySynth.triggerAttackRelease(note, '16n', time); }, ["C4", "E4", "G4", "C5"], "up").start(0);
                Tone.Transport.start();
            }
            const frenzyDuration = 15000 + (powerUps.frenzyFuel.level * 2000);
            const frenzySpinInterval = setInterval(() => spin({isFree: true}), 300);
            frenzyButton.disabled = true;
            frenzyButton.classList.add('frenzy-glow', 'screen-shake');
            setTimeout(() => {
                isFrenzyActive = false;
                clearInterval(frenzySpinInterval);
                if(isAudioReady) {
                    frenzyPattern.stop();
                    Tone.Transport.stop();
                }
                updateFrenzyButton(); 
            }, frenzyDuration);
        }
        
        function fullReset(isPrestige = false) {
            const oldBadges = { ...badges };
            balance = 100;
            wins = 0;
            idleIncome = 1;
            if (!isPrestige) {
                 prestigeLevel = 0;
                 totalWins = 0;
                 secretTitleClicks = 0;
            }
            resetProgress();
             if (isPrestige) {
                Object.keys(oldBadges).forEach(key => {
                    if (badges[key] && oldBadges[key].unlocked && !badges[key].dynamic) {
                        badges[key].unlocked = true;
                    }
                });
             }
            clearInterval(autoSpinnerInterval);
            spinButton.textContent = 'Spin ($5)';
            updateFrenzyButton();
            updatePrestigeButton();
            updateBackground(true);
            gameContainer.classList.remove('theme-inferno');
            updateBalanceDisplay();
            updateWinCounter();
            updateIntensity();
            updateJuiceMeter();
            updateGrandJackpotDisplay();
            renderInfo();
            renderBadges();
            saveGameState();
        }

        function prestige() {
            if (wins < 100) return;
            prestigeLevel++;
            if(isAudioReady) prestigeSynth.triggerAttackRelease("C4", "2s");
            showMessage(`Prestiged! All earnings now +${prestigeLevel * 25}%`, 'text-cyan-400', 5000);
            fullReset(true);
        }

        function checkMilestones() {
            for (const winCount in milestones) {
                if (!milestones[winCount].unlocked && wins >= winCount) {
                    milestones[winCount].unlocked = true;
                    showMessage(`Milestone! ${milestones[winCount].description}`, 'text-yellow-300', 4000);
                    if (winCount == 250) {
                        if (!baseSymbols.some(s => s.emoji === '👑')) { baseSymbols.unshift({ key: 'king', emoji: '👑', payout3: 1000, payout2: 100, level: 0, basePayout3: 1000, basePayout2: 100, upgradeCost: 100000 }); updateWeightedSymbols(); }
                    } else if (winCount == 1000) {
                        gameContainer.classList.add('theme-inferno');
                    }
                    saveGameState();
                    renderInfo();
                }
            }
        }
        
        function spawnRandomPowerUp() {
            const powerUpElement = document.createElement('div');
            const icon = '⭐';
            const baseReward = 10 + Math.random() * (spinCost * 10);
            const scalingFactor = 1 + (wins / 50);
            const finalReward = Math.floor(baseReward * scalingFactor);
            powerUpElement.textContent = icon;
            powerUpElement.className = 'coin';
            powerUpElement.style.left = `${Math.random() * 95}vw`;
            powerUpElement.style.animationDuration = '5s';
            powerUpElement.style.fontSize = '3rem';
            powerUpElement.style.cursor = 'pointer';
            powerUpElement.style.zIndex = '1003';

            powerUpElement.addEventListener('click', (event) => {
                if(isAudioReady) purchaseSynth.triggerAttackRelease("A5", "16n");
                balance += finalReward;
                updateBalanceDisplay();
                showFloatingText(`+$${formatNumber(finalReward)}`, event.clientX, event.clientY);
                powerUpElement.remove();
                saveGameState();
            }, { once: true });
            fallingPowerUpContainer.appendChild(powerUpElement);
            setTimeout(() => { powerUpElement.remove(); }, 5000);
        }

        function unlockBadge(key) {
             if (badges[key] && !badges[key].unlocked) {
                badges[key].unlocked = true;
                showMessage(`Achievement: ${badges[key].name}!`, 'text-yellow-300', 4000, true);
                renderBadges();
                return true;
            }
            return false;
        }

        function checkBadgeUnlocks() {
            if (totalWins >= 10) unlockBadge('win10');
            if (totalWins >= 100) unlockBadge('win100');
            if (totalWins >= 500) unlockBadge('win500');
            if (totalWins >= 1000) unlockBadge('win1000');
            if (badges.frenzy10?.value >= 10) unlockBadge('frenzy10');
            if (balance >= 1000000) unlockBadge('bal1M');
            if (balance >= 1000000000) unlockBadge('bal1B');
            if (prestigeLevel >= 1) unlockBadge('prestige1');
            if (prestigeLevel >= 5) unlockBadge('prestige5');
            const allPowerupsBought = Object.values(powerUps).every(pu => pu.level > 0 || pu.count > 0);
            if (allPowerupsBought) unlockBadge('collector');
            const winCounterBadge = document.getElementById('dynamic-badge-winCounter-value');
            if (winCounterBadge) winCounterBadge.textContent = totalWins;
        }
        
        function renderBadges() {
            badgeDisplayContainer.innerHTML = '';
            Object.entries(badges)
                .filter(([key, badge]) => {
                    if (!badge.unlocked) return false;
                    if (key === 'winCounter' && prestigeLevel === 0) return false;
                    return true;
                })
                .sort(([k1, b1], [k2, b2]) => b1.order - b2.order)
                .forEach(([key, badge]) => {
                    const badgeEl = document.createElement('div');
                    badgeEl.className = 'badge';
                    badgeEl.id = `badge-${key}`;
                    let tooltipText = `<div class='font-bold'>${badge.name}</div><div>${badge.description}</div>`;
                    if (badge.secret && !badge.unlocked) tooltipText = "???";
                    badgeEl.innerHTML = `${badge.icon}${badge.dynamic ? `<span id="dynamic-badge-${key}-value" class="dynamic-badge-value">${totalWins}</span>` : ''}<span class="tooltip">${tooltipText}</span>`;
                    badgeDisplayContainer.appendChild(badgeEl);
            });
        }
        
        function updateGambleButtons() {
            gambleWagerButtons.forEach(button => {
                const percentage = parseFloat(button.dataset.wager);
                button.disabled = balance * percentage <= 0;
            });
        }
        
        const confettiEmojis = ['🎉', '🎊', '✨', '🌟', '🌈', '🥳', '🎈', '💖', '⭐'];
        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.textContent = confettiEmojis[Math.floor(Math.random() * confettiEmojis.length)];
                confetti.classList.add('confetti');
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.animationDelay = `${Math.random() * -3}s`;
                confetti.style.animationDuration = `${3 + Math.random() * 2}s`;
                confettiContainer.appendChild(confetti);
                setTimeout(() => confetti.remove(), 5000);
            }
        }

        // --- Gamble Effects (unchanged) ---
        function showGambleWinEffect(winnings, wagerPercentage) {
            const winText = document.createElement('div');
            winText.textContent = `+$${formatNumber(winnings)}`;
            winText.classList.add('gamble-win-text', 'text-green-400', 'text-5xl', 'font-bold', 'absolute', 'z-[1002]');
            const gameContainerRect = gameContainer.getBoundingClientRect();
            const gambleButtonRect = gambleButton.getBoundingClientRect();
            const topPos = gambleButtonRect.top - gameContainerRect.top;
            const leftPos = gambleButtonRect.left - gameContainerRect.left + (gambleButtonRect.width / 2);
            winText.style.top = `${topPos}px`;
            winText.style.left = `${leftPos}px`;
            gameContainer.appendChild(winText);
            
            gambleButton.textContent = `+${formatNumber(winnings)}`;
            gambleButton.classList.remove('bg-yellow-600', 'hover:bg-yellow-700', 'bg-red-600', 'hover:bg-red-600');
            gambleButton.classList.add('bg-green-500', 'hover:bg-green-600');
            setTimeout(() => {
                gambleButton.textContent = 'Gamble';
                gambleButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                gambleButton.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
            }, 3000);

            if (wagerPercentage >= 0.50) createConfetti();
            if(isAudioReady) {
                const now = Tone.now();
                jackpotSynth.triggerAttackRelease(["C4", "E4", "G4", "C5"], "8n", now);
            }
            winText.addEventListener('animationend', () => winText.remove());
        }

        function showGambleLossEffect(wager) {
            const lossText = document.createElement('div');
            lossText.textContent = `-${formatNumber(wager)}`;
            lossText.classList.add('gamble-loss-explode', 'text-red-400', 'text-5xl', 'font-bold', 'absolute', 'z-[1002]');
            const gameContainerRect = gameContainer.getBoundingClientRect();
            const gambleButtonRect = gambleButton.getBoundingClientRect();
            const topPos = gambleButtonRect.top - gameContainerRect.top + (gambleButtonRect.height / 2);
            const leftPos = gambleButtonRect.left - gameContainerRect.left + (gambleButtonRect.width / 2);
            lossText.style.top = `${topPos}px`;
            lossText.style.left = `${leftPos}px`;
            gameContainer.appendChild(lossText);
            lossText.addEventListener('animationend', () => lossText.remove());
        }
        
        function initiateGamble(percentage) {
            const wager = balance * percentage;
            if (wager > balance) return;
            balance -= wager;
            const win = Math.random() < 0.5;
            if (win) {
                balance += wager * 2;
                showGambleWinEffect(wager * 2, percentage);
                if (percentage === 1.00) unlockBadge('allIn');
            } else {
                if(isAudioReady) {
                    const now = Tone.now();
                    winSynth.triggerAttackRelease("B5", "16n", now);
                    winSynth.triggerAttackRelease("E4", "16n", now + 0.1);
                }
                showGambleLossEffect(wager);
                gambleButton.textContent = `-${formatNumber(wager)}`;
                gambleButton.classList.remove('bg-yellow-600', 'hover:bg-yellow-700', 'bg-green-500', 'hover:bg-green-600');
                gambleButton.classList.add('bg-red-600', 'hover:bg-red-700');
                setTimeout(() => {
                    gambleButton.textContent = 'Gamble';
                    gambleButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                    gambleButton.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                }, 3000);
            }
            updateBalanceDisplay();
            saveGameState();
            toggleMenu(gambleMenu, gambleMenuOverlay);
        }

        // --- Hold & Respin Logic ---
        function updateGrandJackpotDisplay() {
            grandJackpotDisplay.textContent = `GRAND JACKPOT: $${formatNumber(grandJackpot)}`;
        }

        function startHoldAndRespin(triggerSymbols) {
            isHoldRespinActive = true;
            spinButton.disabled = true;
            gambleButton.disabled = true;
            holdRespinOverlay.style.display = 'flex';
            holdRespinGrid.innerHTML = '';
            
            let respins = 3;
            let gridValues = Array(9).fill(null);
            let totalWinnings = 0;

            if(isAudioReady) {
                const now = Tone.now();
                levelUpSynth.triggerAttackRelease("C4", "2n", now);
                levelUpSynth.triggerAttackRelease("G4", "2n", now + 0.1);
            }

            // Place initial coins
            for(let i=0; i<3; i++) {
                if (triggerSymbols[i].key === 'coin') {
                    gridValues[i*3 + i] = Math.floor((5 + Math.random() * 45) * spinCost);
                }
            }

            function renderGrid() {
                holdRespinGrid.innerHTML = '';
                for (let i = 0; i < 9; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'hold-respin-slot';
                    if (gridValues[i] !== null) {
                        slot.classList.add('filled');
                        slot.textContent = `+${formatNumber(gridValues[i])}`;
                    }
                    holdRespinGrid.appendChild(slot);
                }
                holdRespinCounter.textContent = `Respins: ${respins}`;
            }

            function endRound() {
                isHoldRespinActive = false;
                holdRespinOverlay.style.display = 'none';
                updateBalanceDisplay();
                
                let filledCount = gridValues.filter(v => v !== null).length;
                if(filledCount === 9) {
                    // GRAND JACKPOT!
                    showMessage(`GRAND JACKPOT! +$${formatNumber(grandJackpot)}`, 'text-yellow-300', 8000);
                    balance += grandJackpot;
                    if(isAudioReady) prestigeSynth.triggerAttackRelease("A5", "1s");
                    unlockBadge('grandJackpot');
                    
                    const textEl = document.createElement('div');
                    textEl.textContent = `GRAND JACKPOT!`;
                    textEl.className = 'absolute text-6xl font-black text-yellow-300 z-20';
                    textEl.style.textShadow = '0 0 20px black, 0 0 30px black';
                    textEl.style.top = '50%';
                    textEl.style.left = '50%';
                    textEl.style.transform = 'translate(-50%, -50%)';
                    textEl.style.animation = 'grand-jackpot-text-anim 1s forwards';
                    holdRespinOverlay.appendChild(textEl);
                    createConfetti();

                    setTimeout(() => {
                        grandJackpot = 100000; // Reset jackpot
                        updateGrandJackpotDisplay();
                        textEl.remove();
                    }, 4000);

                } else {
                    gridValues.forEach(val => totalWinnings += val || 0);
                    balance += totalWinnings;
                    showMessage(`You won $${formatNumber(totalWinnings)}!`, 'text-green-400', 4000);
                }
                updateBalanceDisplay();
                saveGameState();
            }

            function doRespin() {
                if (respins <= 0) {
                    endRound();
                    return;
                }
                respins--;
                let newCoinLanded = false;
                
                for (let i = 0; i < 9; i++) {
                    if (gridValues[i] === null && Math.random() < 0.25) { // Chance to land a new coin
                        gridValues[i] = Math.floor((5 + Math.random() * 45) * spinCost);
                        newCoinLanded = true;
                        if(isAudioReady) holdRespinSynth.triggerAttackRelease("G4", "8n");
                    }
                }

                if (newCoinLanded) {
                    respins = 3; // Reset
                }
                renderGrid();

                if (gridValues.every(v => v !== null)) {
                    endRound();
                    return;
                }

                setTimeout(doRespin, 1000);
            }
            renderGrid();
            setTimeout(doRespin, 1000);
        }


        function applyVolumeSettings() {
            masterVolume.volume.value = Tone.gainToDb(volumeSettings.master);
            sfxVolume.volume.value = Tone.gainToDb(volumeSettings.sfx);
            masterVolumeSlider.value = volumeSettings.master;
            sfxVolumeSlider.value = volumeSettings.sfx;
            masterVolumeLabel.textContent = `${Math.round(volumeSettings.master * 100)}%`;
            sfxVolumeLabel.textContent = `${Math.round(volumeSettings.sfx * 100)}%`;
        }

        function setupVolumeControls() {
            masterVolumeSlider.addEventListener('input', (e) => {
                const gain = parseFloat(e.target.value);
                volumeSettings.master = gain;
                masterVolume.volume.value = Tone.gainToDb(gain);
                masterVolumeLabel.textContent = `${Math.round(gain * 100)}%`;
                saveGameState();
            });
            sfxVolumeSlider.addEventListener('input', (e) => {
                const gain = parseFloat(e.target.value);
                volumeSettings.sfx = gain;
                sfxVolume.volume.value = Tone.gainToDb(gain);
                sfxVolumeLabel.textContent = `${Math.round(gain * 100)}%`;
                if (isAudioReady) { purchaseSynth.triggerAttackRelease("C5", "16n"); }
                saveGameState();
            });
        }
        
        function toggleMenu(menu, overlay) {
            menu.classList.toggle('hidden');
            overlay.classList.toggle('hidden');
            if (!infoMenu.classList.contains('hidden')) {
                renderInfo();
            }
        }

        function setupEventListeners() {
            gameTitle.addEventListener('click', () => { secretTitleClicks++; if (secretTitleClicks >= 10) unlockBadge('secretClicker'); saveGameState(); });
            frenzyButton.addEventListener('click', startFrenzy);
            gambleButton.addEventListener('click', () => { updateGambleButtons(); toggleMenu(gambleMenu, gambleMenuOverlay); });
            gambleWagerButtons.forEach(button => { button.addEventListener('click', (e) => initiateGamble(parseFloat(e.target.dataset.wager))); });
            document.getElementById('gamble-close').addEventListener('click', () => toggleMenu(gambleMenu, gambleMenuOverlay));
            storeButton.addEventListener('click', () => { renderStore(); toggleMenu(storeMenu, storeMenuOverlay); });
            document.getElementById('store-close').addEventListener('click', () => toggleMenu(storeMenu, storeMenuOverlay));
            storeMenuOverlay.addEventListener('click', () => toggleMenu(storeMenu, storeMenuOverlay));
            infoButton.addEventListener('click', () => toggleMenu(infoMenu, infoMenuOverlay));
            document.getElementById('info-close').addEventListener('click', () => toggleMenu(infoMenu, infoMenuOverlay));
            infoMenuOverlay.addEventListener('click', () => toggleMenu(infoMenu, infoMenuOverlay));
            prestigeButton.addEventListener('click', prestige);
            settingsButton.addEventListener('click', () => { document.getElementById('settings-options').classList.remove('hidden'); document.getElementById('reset-confirmation').classList.add('hidden'); toggleMenu(settingsMenu, settingsMenuOverlay); });
            document.getElementById('settings-close').addEventListener('click', () => toggleMenu(settingsMenu, settingsMenuOverlay));
            settingsMenuOverlay.addEventListener('click', () => toggleMenu(settingsMenu, settingsMenuOverlay));
            document.getElementById('reset-progress-button').addEventListener('click', () => { document.getElementById('settings-options').classList.add('hidden'); document.getElementById('reset-confirmation').classList.remove('hidden'); });
            document.getElementById('cancel-reset-button').addEventListener('click', () => { document.getElementById('settings-options').classList.remove('hidden'); document.getElementById('reset-confirmation').classList.add('hidden'); });
            document.getElementById('confirm-reset-button').addEventListener('click', () => { fullReset(false); toggleMenu(settingsMenu, settingsMenuOverlay); });
            
            let dKeyPresses = 0; let dKeyPressTimer;
            window.addEventListener('keydown', (e) => {
                if (e.key.toLowerCase() === 'd') {
                    dKeyPresses++; clearTimeout(dKeyPressTimer);
                    dKeyPressTimer = setTimeout(() => { dKeyPresses = 0; }, 1000);
                    if (dKeyPresses === 3) { dKeyPresses = 0; toggleMenu(devMenu, devMenuOverlay); }
                }
            });
            document.getElementById('dev-add-money').addEventListener('click', () => { balance += 1000; updateBalanceDisplay(); });
            document.getElementById('dev-add-wins').addEventListener('click', () => { wins += 10; totalWins += 10; updateWinCounter(); updateIntensity(); updateBackground(); });
            document.getElementById('dev-reset').addEventListener('click', () => fullReset(false));
            document.getElementById('dev-close').addEventListener('click', () => toggleMenu(devMenu, devMenuOverlay));
            devMenuOverlay.addEventListener('click', () => toggleMenu(devMenu, devMenuOverlay));
            document.getElementById('dev-add-prestige').addEventListener('click', () => { prestigeLevel++; fullReset(true); });
            document.getElementById('dev-add-frenzy').addEventListener('click', () => { powerUps.frenzyToken.count++; updateFrenzyButton(); saveGameState(); });
            document.getElementById('dev-unlock-milestones').addEventListener('click', () => { wins = 1000; updateWinCounter(); checkMilestones(); saveGameState(); });
            document.getElementById('dev-spawn-powerup').addEventListener('click', spawnRandomPowerUp);
            document.getElementById('dev-add-juice').addEventListener('click', () => { addJuice(maxJuice); });
        }
        
        // --- Initialization ---
        window.onload = () => {
            gameContainer = document.getElementById('game-container');
            gameTitle = document.getElementById('game-title');
            statsPanel = document.getElementById('stats-panel');
            balanceDisplay = document.getElementById('balance');
            winCounter = document.getElementById('win-counter');
            prestigeDisplay = document.getElementById('prestige-display');
            grandJackpotDisplay = document.getElementById('grand-jackpot-display');
            slotElementsWithParents = Array.from(document.querySelectorAll('.slot'));
            slotElements = slotElementsWithParents.map(el => el.querySelector('.slot-inner'));
            spinButton = document.getElementById('spinButton');
            storeButton = document.getElementById('storeButton');
            settingsButton = document.getElementById('settingsButton');
            infoButton = document.getElementById('infoButton');
            prestigeButton = document.getElementById('prestigeButton');
            messageBox = document.getElementById('message');
            devMenu = document.getElementById('dev-menu');
            devMenuOverlay = document.getElementById('dev-menu-overlay');
            storeMenu = document.getElementById('store-menu');
            storeMenuOverlay = document.getElementById('store-menu-overlay');
            settingsMenu = document.getElementById('settings-menu');
            settingsMenuOverlay = document.getElementById('settings-menu-overlay');
            gambleMenu = document.getElementById('gamble-menu');
            gambleMenuOverlay = document.getElementById('gamble-menu-overlay');
            infoMenu = document.getElementById('info-menu');
            infoMenuOverlay = document.getElementById('info-menu-overlay');
            powerUpsContainer = document.getElementById('power-ups-container');
            fallingMoneyContainer = document.getElementById('falling-money-container');
            fallingPowerUpContainer = document.getElementById('falling-powerup-container');
            confettiContainer = document.getElementById('confetti-container');
            frenzyButton = document.getElementById('frenzyButton');
            frenzyCoinCount = document.getElementById('frenzy-coin-count');
            gambleButton = document.getElementById('gambleButton');
            gambleWagerButtons = document.querySelectorAll('.gamble-wager-button');
            badgeDisplayContainer = document.getElementById('badge-display-container');
            masterVolumeSlider = document.getElementById('master-volume');
            sfxVolumeSlider = document.getElementById('sfx-volume');
            masterVolumeLabel = document.getElementById('master-volume-label');
            sfxVolumeLabel = document.getElementById('sfx-volume-label');
            juiceMeterBar = document.getElementById('juice-meter-bar');
            juiceMeterText = document.getElementById('juice-meter-text');
            holdRespinOverlay = document.getElementById('hold-respin-overlay');
            holdRespinGrid = document.getElementById('hold-respin-grid');
            holdRespinCounter = document.getElementById('hold-respin-counter');


            loadGameState();
            setupVolumeControls();
            setupEventListeners();
            spinButton.addEventListener('click', () => spin());
            startIdleIncome();
            updateGrandJackpotDisplay();
            showMessage("Click Spin to Start!", "text-yellow-300", 3000);
            
            setInterval(() => {
                const intensity = Math.floor(wins / 10);
                if (intensity > 0 && Math.random() < 0.05 * intensity) {
                    spawnRandomPowerUp();
                }
            }, 5000);
        };
        document.body.addEventListener('click', initializeAudio, { once: true });

    </script>
</body>
</html>